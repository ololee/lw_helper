<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unicode转UTF-8工具</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="/static/js/decode_helper.js"></script>
</head>
<body>
    <div class="main-container">
    <div class="decoder-container">
        <h1 class="decoder-title">Unicode转UTF-8解码器</h1>

        <div class="input-section">
            <label for="unicode-input" class="section-label">Unicode编码字符串:</label>
            <textarea id="unicode-input" class="text-input" placeholder="请输入Unicode编码的字符串，例如：\160\097\106"></textarea>
        </div>

        <div class="button-group">
            <button id="decode-btn" class="decode-btn">解码为UTF-8</button>
            <button id="clear-btn" class="clear-btn">清空输入</button>
        </div>

        <div class="output-section">
            <label for="utf8-output" class="section-label">UTF-8解码结果:</label>
            <textarea id="utf8-output" class="text-output" readonly placeholder="解码结果将显示在这里..."></textarea>
        </div>

        <button id="copy-btn" class="copy-btn">复制结果</button>
    </div>

    <div class="history-container">
        <div class="history-header">
            <h2>历史记录</h2>
            <button id="clear-history" class="clear-history-btn">清空</button>
        </div>
        <div id="history-list" class="history-list">
            <div class="empty-history">暂无历史记录</div>
        </div>
    </div>
</div>

    <div id="copy-notification" class="copy-notification">已复制到剪贴板!</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化历史记录
            renderHistory();

            // 清空历史记录按钮事件
            document.getElementById('clear-history')?.addEventListener('click', function() {
                if (confirm('确定要清空所有历史记录吗？')) {
                    localStorage.removeItem('unicodeDecoderHistory');
                    renderHistory();
                }
            });

            const unicodeInput = document.getElementById('unicode-input');
            const utf8Output = document.getElementById('utf8-output');
            const decodeBtn = document.getElementById('decode-btn');
            const clearBtn = document.getElementById('clear-btn');
            const copyBtn = document.getElementById('copy-btn');
            const copyNotification = document.getElementById('copy-notification');

            // 保存解码结果到历史记录
            function saveToHistory(input, output) {
                const history = JSON.parse(localStorage.getItem('unicodeDecoderHistory') || '[]');
                
                // 添加新记录到开头
                history.unshift({
                    input: input,
                    output: output,
                    timestamp: new Date().toISOString()
                });
                
                // 限制历史记录数量（最多20条）
                if (history.length > 20) {
                    history.pop();
                }
                
                localStorage.setItem('unicodeDecoderHistory', JSON.stringify(history));
                renderHistory();
            }

            // 渲染历史记录
            function renderHistory() {
                const historyList = document.getElementById('history-list');
                const history = JSON.parse(localStorage.getItem('unicodeDecoderHistory') || '[]');
                
                if (history.length === 0) {
                    historyList.innerHTML = '<div class="empty-history">暂无历史记录</div>';
                    return;
                }
                
                historyList.innerHTML = '';
    
                history.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <div class="history-input">${truncateText(item.input, 30)}</div>
                        <div class="history-output">${truncateText(item.output, 40)}</div>
                        <div class="history-time">${formatTime(item.timestamp)}</div>
                    `;
                    
                    // 点击历史记录项，将内容加载到输入框
                    historyItem.addEventListener('click', () => {
                        unicodeInput.value = item.input;
                        utf8Output.value = item.output;
                    });
                    
                    historyList.appendChild(historyItem);
                });
            }

            // 辅助函数：截断长文本
            function truncateText(text, maxLength) {
                if (text.length <= maxLength) return text;
                return text.substring(0, maxLength) + '...';
            }

            // 辅助函数：格式化时间戳
            function formatTime(timestamp) {
                const date = new Date(timestamp);
                return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            }

            // 解码Unicode到UTF-8
            decodeBtn.addEventListener('click', function() {
                let input = unicodeInput.value;
                if (!input)
                {
                    return;
                }

                try {
                    input = input.trim();
                    let idx = 0;
                    let finalStr = "";
                    let tmpArr = [];
                    processString(input,(code)=>{
                        tmpArr.push(code);
                        if(tmpArr.length === 3)
                        {
                            finalStr += decodeToStr(tmpArr);
                        }
                    },(s)=>{
                        finalStr += s;
                    });
                    utf8Output.value = finalStr;

                // 保存到历史记录
                if (finalStr && finalStr !== '解码失败: ') {
                    saveToHistory(input, finalStr);
                }
                } catch (e) {
                    utf8Output.value = '解码失败: ' + e.message;
                }
            });

            // 清空输入
            clearBtn.addEventListener('click', function() {
                unicodeInput.value = '';
                utf8Output.value = '';
                unicodeInput.focus();
            });

            // 复制结果
            copyBtn.addEventListener('click', function() {
                if (!utf8Output.value) return;

                utf8Output.select();
                document.execCommand('copy');

                // 显示复制成功通知
                copyNotification.classList.add('show');
                setTimeout(() => {
                    copyNotification.classList.remove('show');
                }, 2000);
            });

            // 支持回车键解码
            unicodeInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    decodeBtn.click();
                }
            });
        });
    </script>
</body>
</html>